---
title: Illustration of variational Gaussian approximation for Poisson-normal model with one unknown
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the functions implementing the variational inference algorithms
and set the seed.

```{r setup}
source("../code/vgapois.R")
set.seed(1)
```

Simulate data
-------------

Simulate counts from the following Poisson model: $y_i \sim
\mathrm{Poisson}(\lambda_i)$, in which $\log \lambda_i = b_0 + b x_i$.

```{r sim-data}
n  <- 10
b0 <- -1
b  <- 1.5
x  <- rnorm(n)
r  <- exp(b0 + x*b)
y  <- rpois(n,r)
```

Compute Monte Carlo estimate of marginal likelihood
---------------------------------------------------

Here we compute an importance sampling estimate of the marginal
log-likelihood, in which the prior on $b$ is normal with mean zero and
standard deviation $s_0$. We will compare this against the lower bound
to the marginal likelihood obtained by the variational approximation.

```{r importance-sampling}
s0   <- 3
ns   <- 1e5
b    <- rnorm(ns,sd = sqrt(s0))
logw <- rep(0,ns)
for (i in 1:ns)
  logw[i] <- compute_loglik_pois(x,y,b0,b[i])
a    <- max(logw)
logZ <- log(mean(exp(logw - a))) + a
```

Fit variational approximation
-----------------------------

Fit the variational Gaussian approximation by optimizing the
variational lower bound (the "ELBO").

```{r fit-vga}
fit <- vgapois1(x,y,b0,s0)
cat(sprintf("Monte Carlo estimate:    %0.12f\n",logZ))
cat(sprintf("Variational lower bound: %0.12f\n",-fit$value))
```

Compare exact and approximate posterior distributions
-----------------------------------------------------

```{r, fig.height=3, fig.width=3}
mu  <- fit$par["mu"]
s   <- fit$par["s"]
b    <- seq(-1,3,length.out = 1000)
n    <- length(b)
logp <- rep(0,n)
qb   <- dnorm(b,mu,sqrt(s))
for (i in 1:n)
  logp[i] <- compute_logp_pois(x,y,b0,b[i],s0)
maxlp <- max(logp)
plot(b,exp(logp - maxlp),type = "l",lwd = 2,col = "dodgerblue",
     xlab = "b",ylab = "relative posterior")
lines(b,qb/max(qb),col = "magenta",lwd = 2)
```
